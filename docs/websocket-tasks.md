# WebSocket USD/JPY 配信とリアルタイムUI 実装タスク

このドキュメントは、`ticker_usd_jpy` のデータを配信する WebSocket サーバーと、
リアルタイム表示 UI を段階的に実装するための作業計画である。

方針は「既存 Vue 統合より先に、単独ページで PoC を成立させる」。

## 想定データフロー

- `coin.z websocket -> gmo/ws-connection.py -> ticker_usd_jpy(1秒単位 insert) -> gmo/ws_ticker_server.py -> UI`
- `gmo/ws_ticker_server.py` は coin.z へ直接接続せず、`ticker_usd_jpy` への追加分を配信する。

## 進捗ステータス（2026-02-16）

- `T1`: 完了
  - `docs/ws_ticker_spec.md` を作成し、配信仕様を固定
- `T2`: 完了
  - `gmo/ws_ticker_server.py` を追加
  - `/ws/ticker_usd_jpy` の接続受付、接続数ログ、30秒 heartbeat を実装
  - `requirements.txt` に `websockets` を追加
- `T3`: 完了
  - `gmo/ws_ticker_server.py` を DB ポーリング配信へ変更
  - `ticker_usd_jpy` 追加分のみ配信するカーソル管理を実装
  - 最新 `ticker` 1 件キャッシュ保持と新規接続時即時送信を実装
- `T4`: 未着手
- `T5`: 未着手
- `T6`: 未着手
- `T7`: 未着手

## チケット一覧（実装順）

### T1: WebSocket 配信仕様を固定する
- 目的: UI/サーバー間のズレを防ぐ
- ステータス: 完了
- 完了条件:
  - メッセージ JSON を決定（`ticker` / `heartbeat` / `error`）
  - 必須項目: `symbol`, `bid`, `ask`, `mid`, `timestamp`
  - `docs/ws_ticker_spec.md` を作成

### T2: 配信サーバーの骨組みを作る
- 目的: `/ws/ticker_usd_jpy` で接続受付できる状態にする
- ステータス: 完了
- 完了条件:
  - クライアント接続/切断を管理
  - 接続数ログが出る
  - 空の heartbeat を 30 秒ごと送信

### T3: DB 追加検知 -> 配信サーバー配信
- 目的: `ticker_usd_jpy` に追加されたデータを WebSocket で UI へ配信する
- ステータス: 完了
- 完了条件:
  - `ticker_usd_jpy` の最新レコード追加を検知できる
  - 未配信分のみブロードキャストし、重複配信を防止できる
  - 全接続クライアントへブロードキャスト
  - 最新 1 件キャッシュを保持（新規接続時即送信）
  - `ticker` メッセージ形式は `docs/ws_ticker_spec.md` に準拠する
- 実装メモ:
  - 初版は短周期ポーリングで検知する
  - 将来改善として DB 通知機能（`LISTEN/NOTIFY` 等）の採用余地を残す（このチケット対象外）

### T4: 最小 UI（単独ページ）を実装
- 目的: ブラウザでリアルタイム配信とチャート表示を確認
- 完了条件:
  - `mid` の時系列ラインをリアルタイム描画できる
  - `bid`, `ask`, `mid`, `timestamp` が更新される
  - 上昇/下降で色変化
  - 接続状態バッジ表示
  - 最新受信時刻を表示する

### T5: UI 再接続と異常系を実装
- 目的: 実運用に近い耐障害性を持たせる
- 完了条件:
  - 切断時に指数バックオフで再接続
  - stale 判定（例: 5 秒更新なしで警告）
  - エラーメッセージの簡易表示

### T6: Docker/起動導線を追加
- 目的: 手元再現を簡単にする
- 完了条件:
  - `docker-compose.yaml` にサービス追記
  - 起動手順を `README.md` へ追記
  - ローカル起動コマンドを 1 つに整理

### T7: 動作確認チェックリスト作成
- 目的: PoC 完了判定を明確化
- 完了条件:
  - 正常系（接続/受信/表示）3 項目
  - 異常系（DB更新停止/再接続）3 項目
  - 計測項目（遅延目安、更新頻度）を記録

## 依存関係

- `T1 -> T2 -> T3 -> T4 -> T5 -> T6 -> T7`
- `T4` 以降は `T3`（DB起点の配信）完了が前提

## 見積り（目安）

- `T1`: 0.5 日
- `T2-T3`: 1.0〜1.5 日
- `T4-T5`: 1.0 日
- `T6-T7`: 0.5 日
- 合計: `3〜3.5 日`
